<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian History Bite - AI-Generated Stories</title>
    <meta name="description" content="Educational project showcasing AI-generated stories about Indian history. Content may contain inaccuracies - please verify facts.">

    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">

    <!-- DOMPurify removed - using manual sanitization instead -->

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 20px auto;
            width: 90%;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin: 0 0 25px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .story-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .story-subtitle {
            font-size: 18px;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        
        .story-body {
            font-size: 16px;
            line-height: 1.7;
            color: #34495e;
            margin-bottom: 25px;
            text-align: justify;
        }
        
        .story-body strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .story-body p {
            margin-bottom: 16px;
        }
        
        .story-body em {
            font-style: italic;
            color: #555;
        }
        
        .story-body .date {
            color: #667eea;
            font-weight: normal;
        }
        
        .story-body .quote-inline {
            font-style: italic;
            color: #555;
            background: rgba(102, 126, 234, 0.05);
            padding: 0 4px;
            border-radius: 3px;
        }
        
        .story-quote {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-size: 16px;
            font-style: italic;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
        }
        
        .story-quote:before {
            content: '"';
            font-size: 48px;
            position: absolute;
            top: -5px;
            left: 15px;
            opacity: 0.7;
        }
        
        .story-quote:after {
            content: '"';
            font-size: 48px;
            position: absolute;
            bottom: -25px;
            right: 15px;
            opacity: 0.7;
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #f1948a;
        }

        .disclaimer {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 1200px;
            width: 90%;
            border-left: 4px solid #ffc107;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #664d03;
        }

        .disclaimer a {
            color: #0056b3;
            text-decoration: underline;
        }

        .footer {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 767px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 20px 15px;
                margin: 10px auto;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .story-title {
                font-size: 24px;
            }
            
            .story-subtitle {
                font-size: 16px;
            }
            
            .story-body {
                font-size: 15px;
            }

            .disclaimer {
                font-size: 12px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="disclaimer">
        <strong>‚ö†Ô∏è Educational Project:</strong> This content is generated by AI for educational purposes only.
        Historical information may contain inaccuracies. Please verify facts with authoritative sources.
        This project demonstrates AI integration and is not intended as a historical reference.
        <a href="https://github.com/yourusername/indianhistorybite" target="_blank">Learn more</a>
    </div>

    <div class="container">
        <h1>Indian History Bite</h1>
        
        <div id="story-content">
            <div id="story-title" class="story-title">Loading...</div>
            <div id="story-subtitle" class="story-subtitle"></div>
            <div id="story-body" class="story-body"></div>
            <div id="story-quote" class="story-quote"></div>
        </div>
    </div>

    <script>
        // Decode HTML entities
        function decodeHTML(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }

        // XSS Protection: Simplified sanitization for trusted content
        function sanitizeHTML(dirty) {
            // Since content comes from our own API and we control the formatting,
            // we just need basic sanitization
            const temp = document.createElement('div');
            temp.innerHTML = dirty;

            // Remove any script tags or event handlers as a safety measure
            const scripts = temp.querySelectorAll('script');
            scripts.forEach(script => script.remove());

            // Remove event handler attributes
            const allElements = temp.querySelectorAll('*');
            allElements.forEach(el => {
                const attrs = Array.from(el.attributes);
                attrs.forEach(attr => {
                    if (attr.name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });

            return temp.innerHTML;
        }

        // Determine base path from current URL (supports nested deploys)
        function getBasePath() {
            const path = window.location.pathname;
            const parts = path.split('/').filter(Boolean);
            return parts.length > 0 ? `/${parts[0]}` : '';
        }

        // Fetch and display content with robust parsing
        async function fetchResult() {
            try {
                const cacheBuster = new Date().getTime();
                const base = getBasePath() || '/indianhistorybite';
                const url = `${base}/api/result?t=${cacheBuster}`;
                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });

                const contentType = response.headers.get('content-type') || '';
                if (!response.ok) {
                    let bodyText = '';
                    try { bodyText = await response.text(); } catch (_) {}
                    throw new Error(`HTTP ${response.status} ${response.statusText} - ${bodyText.slice(0, 200)}`);
                }

                let data;
                if (contentType.includes('application/json') || contentType.includes('json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text);
                    } catch (_) {
                        throw new Error(`Expected JSON but received ${contentType || 'unknown'}: ${text.slice(0, 200)}`);
                    }
                }

                displayStoryContent(data);
            } catch (error) {
                document.getElementById('story-title').textContent = 'Connection Error';
                document.getElementById('story-subtitle').textContent = '';
                document.getElementById('story-body').innerHTML = sanitizeHTML(`<div class="error">Unable to load content: ${error.message}</div>`);
                document.getElementById('story-quote').style.display = 'none';
            }
        }
        
        // Display story content
        function displayStoryContent(data) {
            const storyTitle = document.getElementById('story-title');
            const storySubtitle = document.getElementById('story-subtitle');
            const storyBody = document.getElementById('story-body');
            const storyQuote = document.getElementById('story-quote');
            
            if (data.error) {
                storyTitle.textContent = 'Error';
                storySubtitle.textContent = '';
                storyBody.innerHTML = sanitizeHTML(`<div class="error">${data.error}</div>`);
                storyQuote.style.display = 'none';
            } else if (data.isProcessing) {
                storyTitle.textContent = 'Loading your history story...';
                storySubtitle.textContent = '';
                storyBody.innerHTML = sanitizeHTML('<div class="loading">üìö Preparing today\'s historical tale...</div>');
                storyQuote.style.display = 'none';
            } else {
                try {
                    let storyData;

                    // Handle response - it should now be an object directly from server
                    if (typeof data.response === 'object' && data.response !== null) {
                        // Response is already an object
                        storyData = data.response;
                    } else if (typeof data.response === 'string') {
                        // Fallback: try to parse string response
                        storyData = JSON.parse(data.response);
                    } else {
                        throw new Error('Invalid response format');
                    }

                    if (storyData.name && storyData.content) {
                        // Display the name prominently
                        storyTitle.textContent = storyData.name;
                        storySubtitle.textContent = storyData.title || '';
                        
                        // Process the content for better formatting
                        let content = storyData.content;
                        
                        // Split into paragraphs (handling both \n\n and single \n)
                        let paragraphs = content.split(/\n\n|\n(?=[A-Z])/);
                        
                        // Format each paragraph
                        let formattedContent = paragraphs.map(paragraph => {
                            // Skip empty paragraphs
                            if (!paragraph.trim()) return '';

                            // Apply text formatting directly (content is plain text from JSON)
                            let formatted = paragraph
                                // Bold text
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                // Italic text
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                // Quotes
                                .replace(/"([^"]+)"/g, '"<span class="quote-inline">$1</span>"');

                            return `<p>${formatted}</p>`;
                        }).filter(p => p !== '').join('');

                        // Insert sanitized content
                        storyBody.innerHTML = sanitizeHTML(formattedContent);

                        // Display the quote if available (use textContent for safety)
                        if (storyData.shareableQuote) {
                            storyQuote.textContent = storyData.shareableQuote;
                            storyQuote.style.display = 'block';
                        } else {
                            storyQuote.style.display = 'none';
                        }
                    } else {
                        throw new Error('Invalid story format');
                    }
                } catch (e) {
                    // Fallback for non-JSON content
                    console.error('Error parsing story:', e);
                    console.error('Response type:', typeof data.response);
                    console.error('Response sample:', data.response ? data.response.substring(0, 200) : 'null');

                    storyTitle.textContent = 'Parsing Error';
                    storySubtitle.textContent = '';
                    storyBody.innerHTML = sanitizeHTML(`<div class="error">Unable to parse story content. Error: ${e.message}</div>`);
                    storyQuote.style.display = 'none';
                }
            }
        }
        
        // Load content on page load
        document.addEventListener('DOMContentLoaded', fetchResult);
    </script>
</body>
</html>
